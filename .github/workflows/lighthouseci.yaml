name: Lighthouse CI

on:
  push:
    branches:
      - main

jobs:
  lighthouse:
    runs-on: ubuntu-latest

    steps:
    # Checkout do código
    - name: Checkout code
      uses: actions/checkout@v2

    # Instala dependências
    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '14'

    - name: Install dependencies
      run: npm install

    # Rodar o Lighthouse CI
    - name: Run Lighthouse CI
      run: npm run lhci -- --ci

    # Verificar se o diretório .lighthouseci existe agora (após a execução do Lighthouse)
    - name: Check if .lighthouseci directory exists
      run: |
        echo "Checking for .lighthouseci directory..."
        if [ -d "midaz-console/.lighthouseci" ]; then
          echo ".lighthouseci directory exists."
          ls -alR midaz-console/.lighthouseci
        else
          echo ".lighthouseci directory does not exist."
        fi

    # Verificar arquivos gerados após LHCI
    - name: Check generated files after LHCI run
      run: |
        echo "Listing contents of the .lighthouseci directory"
        ls -alR midaz-console/.lighthouseci || echo "No .lighthouseci directory found"

    - name: Upload Lighthouse Report
      uses: actions/upload-artifact@v4
      with:
        name: lighthouse-report
        path: |
          midaz-console/.lighthouseci/*.html
          midaz-console/.lighthouseci/*.json
        if-no-files-found: error
        compression-level: 6
        overwrite: false
        include-hidden-files: false